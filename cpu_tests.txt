.F................................F......FFF                             [100%]
=================================== FAILURES ===================================
____________________________ test_drift_growth_rate ____________________________

    def test_drift_growth_rate():
        cfg = Config()
        cfg.trainer.debug_mode = True
    
        state = TrainerState(cfg)
    
>       assert state.env_info is not None
E       assert None is not None
E        +  where None = TrainerState(prev_lstm_unit_metrics=None, update_idx=0, lr=0.0, entropy_coef=0.0, clip_range=0.15, target_kl=0.005, ea... entropy_scheduled=0.0, entropy_delta=0.0, explained_var=0.0, kl_watchdog_triggered=0, steps=0), validation_mode=False).env_info

tests/cpu/drifts/test_drift_growth_rate.py:19: AssertionError
_______________________ test_policy_actor_identity_path ________________________

trainer_state = TrainerState(prev_lstm_unit_metrics=None, update_idx=0, lr=0.0, entropy_coef=0.0, clip_range=0.15, target_kl=0.005, ea... entropy_scheduled=0.0, entropy_delta=0.0, explained_var=0.0, kl_watchdog_triggered=0, steps=0), validation_mode=False)

    def test_policy_actor_identity_path(trainer_state: TrainerState):
        """
        Smoke test: when action_dim == 0, the policy must:
          - use nn.Identity() as the actor head
          - avoid constructing Linear(H, 0)
          - produce correctly shaped outputs for a dummy forward pass
        """
        assert trainer_state.env_info is not None
    
        cfg = Config()
    
        # Force actor identity path
        trainer_state.env_info.action_dim = 0
        trainer_state.env_info.flat_obs_dim = 4  # nonzero so encoder is normal
        cfg.lstm.enc_hidden_size = 16
        cfg.lstm.lstm_hidden_size = 8
    
        policy = LSTMPPOPolicy(trainer_state)
    
        # --- Actor must be Identity ---
        assert isinstance(policy.actor, nn.Identity)
    
        # --- Forward pass must work with action_dim == 0 ---
        B = 4
        H = cfg.lstm.lstm_hidden_size
    
        obs = torch.zeros(B, trainer_state.env_info.flat_obs_dim)
        hxs = torch.zeros(B, H)
        cxs = torch.zeros(B, H)
    
>       out = policy.forward(PolicyInput(obs=obs, hxs=hxs, cxs=cxs))

tests/cpu/policy/test_policy_actor_identity.py:39: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
lstmppo/policy.py:303: in forward
    core_out = self._forward_core(inp.obs, inp.hxs, inp.cxs)
lstmppo/policy.py:250: in _forward_core
    h, c, gates = self.lstm(enc[:, t, :], (h, c))
../../miniconda/envs/cage2_env/lib/python3.10/site-packages/torch/nn/modules/module.py:1775: in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
../../miniconda/envs/cage2_env/lib/python3.10/site-packages/torch/nn/modules/module.py:1786: in _call_impl
    return forward_call(*args, **kwargs)
lstmppo/policy.py:108: in forward
    return self.cell(x, state)
../../miniconda/envs/cage2_env/lib/python3.10/site-packages/torch/nn/modules/module.py:1775: in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
../../miniconda/envs/cage2_env/lib/python3.10/site-packages/torch/nn/modules/module.py:1786: in _call_impl
    return forward_call(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = GateLSTMCell()
x = tensor([[0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
         0., ..., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
         0., 0., 0., 0., 0., 0., 0., 0.]], grad_fn=<SelectBackward0>)
hx = (tensor([[0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., ...[0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0.]]))

    def forward(self, x, hx):
        h, c = hx  # each (B, H)
    
        self._apply_dropconnect()
    
        assert isinstance(x, torch.Tensor)
        assert isinstance(h, torch.Tensor)
        assert isinstance(self.weight_ih, torch.Tensor)
        assert isinstance(self.weight_hh, torch.Tensor)
        assert isinstance(self.bias_ih, torch.Tensor)
        assert isinstance(self.bias_hh, torch.Tensor)
    
>       gates = x @ self.weight_ih.t() + h @ self.weight_hh.t() + self.bias_ih + self.bias_hh
E       RuntimeError: mat1 and mat2 shapes cannot be multiplied (4x8 and 128x512)

lstmppo/policy.py:81: RuntimeError
_____________________________ test_ppo_kl_watchdog _____________________________

    def test_ppo_kl_watchdog():
        """
        Smoke test: PPO must detect synthetic KL drift.
        If new_logp is shifted away from old_logp, approx_kl must increase.
        """
    
        cfg = Config()
        cfg.trainer.cuda = False
    
>       trainer = LSTMPPOTrainer(cfg)

tests/cpu/ppo/test_ppo_kl_watchdog.py:31: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
lstmppo/trainer.py:89: in __init__
    self.state.env_info = RuntimeEnvInfo.from_env(self.env.venv.envs[0])
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

cls = <class 'lstmppo.runtime_env_info.RuntimeEnvInfo'>
env = <PassiveEnvChecker<PositionOnlyCartPoleEasy<popgym-PositionOnlyCartPoleEasy-v0>>>

    @classmethod
    def from_env(cls, env: gym.Env):
        obs_space = env.observation_space
        flat_obs_dim = get_flat_obs_dim(obs_space)
    
        if isinstance(env.action_space, Discrete):
            action_dim = env.action_space.n
>           assert isinstance(action_dim, int)
E           AssertionError

lstmppo/runtime_env_info.py:24: AssertionError
_____________________________ test_ppo_loss_shapes _____________________________

    def test_ppo_loss_shapes():
        cfg = Config()
        cfg.trainer.cuda = False
    
        # Create a trainer (it owns compute_losses)
>       trainer = LSTMPPOTrainer(cfg)

tests/cpu/ppo/test_ppo_losses.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
lstmppo/trainer.py:89: in __init__
    self.state.env_info = RuntimeEnvInfo.from_env(self.env.venv.envs[0])
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

cls = <class 'lstmppo.runtime_env_info.RuntimeEnvInfo'>
env = <PassiveEnvChecker<PositionOnlyCartPoleEasy<popgym-PositionOnlyCartPoleEasy-v0>>>

    @classmethod
    def from_env(cls, env: gym.Env):
        obs_space = env.observation_space
        flat_obs_dim = get_flat_obs_dim(obs_space)
    
        if isinstance(env.action_space, Discrete):
            action_dim = env.action_space.n
>           assert isinstance(action_dim, int)
E           AssertionError

lstmppo/runtime_env_info.py:24: AssertionError
_________________________ test_ppo_value_monotonicity __________________________

    def test_ppo_value_monotonicity():
        """
        Smoke test: critic loss must increase when value predictions
        move farther away from returns.
        """
    
        cfg = Config()
        cfg.trainer.cuda = False
    
>       trainer = LSTMPPOTrainer(cfg)

tests/cpu/ppo/test_ppo_value_monotonicity.py:33: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
lstmppo/trainer.py:89: in __init__
    self.state.env_info = RuntimeEnvInfo.from_env(self.env.venv.envs[0])
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

cls = <class 'lstmppo.runtime_env_info.RuntimeEnvInfo'>
env = <PassiveEnvChecker<PositionOnlyCartPoleEasy<popgym-PositionOnlyCartPoleEasy-v0>>>

    @classmethod
    def from_env(cls, env: gym.Env):
        obs_space = env.observation_space
        flat_obs_dim = get_flat_obs_dim(obs_space)
    
        if isinstance(env.action_space, Discrete):
            action_dim = env.action_space.n
>           assert isinstance(action_dim, int)
E           AssertionError

lstmppo/runtime_env_info.py:24: AssertionError
=========================== short test summary info ============================
FAILED tests/cpu/drifts/test_drift_growth_rate.py::test_drift_growth_rate - a...
FAILED tests/cpu/policy/test_policy_actor_identity.py::test_policy_actor_identity_path
FAILED tests/cpu/ppo/test_ppo_kl_watchdog.py::test_ppo_kl_watchdog - Assertio...
FAILED tests/cpu/ppo/test_ppo_losses.py::test_ppo_loss_shapes - AssertionError
FAILED tests/cpu/ppo/test_ppo_value_monotonicity.py::test_ppo_value_monotonicity
5 failed, 39 passed in 1.53s
